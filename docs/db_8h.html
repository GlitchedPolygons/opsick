<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>opsick: include/opsick/db.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">opsick
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_d44c64559bbebec7f509842c48db8b23.html">include</a></li><li class="navelem"><a class="el" href="dir_33f42f2909a819ca4e752310670f88fa.html">opsick</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">db.h File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Opsick DB interaction functions.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stddef.h&gt;</code><br />
<code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;libpq-fe.h&gt;</code><br />
<code>#include &quot;<a class="el" href="user_8h_source.html">user.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for db.h:</div>
<div class="dyncontent">
<div class="center"><img src="db_8h__incl.png" border="0" usemap="#ainclude_2opsick_2db_8h" alt=""/></div>
<map name="ainclude_2opsick_2db_8h" id="ainclude_2opsick_2db_8h">
<area shape="rect" title="Opsick DB interaction functions." alt="" coords="81,5,216,32"/>
<area shape="rect" title=" " alt="" coords="5,80,73,107"/>
<area shape="rect" title=" " alt="" coords="107,155,172,181"/>
<area shape="rect" title=" " alt="" coords="149,80,223,107"/>
<area shape="rect" href="user_8h.html" title="Contains the opsick_user_metadata struct." alt="" coords="247,80,306,107"/>
<area shape="rect" title=" " alt="" coords="223,155,330,181"/>
</map>
</div>
</div>
<p><a href="db_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a277790655c65b7d13ce1197c4c1bfd94"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a277790655c65b7d13ce1197c4c1bfd94">opsick_db_init</a> (const char *dbconn_filepath)</td></tr>
<tr class="separator:a277790655c65b7d13ce1197c4c1bfd94"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a85551b047f3c11fb87b8e9e7257f17bc"><td class="memItemLeft" align="right" valign="top">PGconn *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a85551b047f3c11fb87b8e9e7257f17bc">opsick_db_connect</a> ()</td></tr>
<tr class="separator:a85551b047f3c11fb87b8e9e7257f17bc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a36c6a53151f5713ed4a8ccf157bc09d8"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a36c6a53151f5713ed4a8ccf157bc09d8">opsick_db_disconnect</a> (PGconn *dbconn)</td></tr>
<tr class="separator:a36c6a53151f5713ed4a8ccf157bc09d8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a50c127ac5529eeb1c52b6e9d3d46685f"><td class="memItemLeft" align="right" valign="top">uint64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a50c127ac5529eeb1c52b6e9d3d46685f">opsick_db_get_schema_version_number</a> ()</td></tr>
<tr class="separator:a50c127ac5529eeb1c52b6e9d3d46685f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3f5d3b4462ea61dff9dcc8b441386a54"><td class="memItemLeft" align="right" valign="top">uint64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a3f5d3b4462ea61dff9dcc8b441386a54">opsick_db_get_last_used_userid</a> ()</td></tr>
<tr class="separator:a3f5d3b4462ea61dff9dcc8b441386a54"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0c9a3cf6b4f6bcd72fcb25d91c2a2013"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a0c9a3cf6b4f6bcd72fcb25d91c2a2013">opsick_db_last_128_bytes_of_ciphertext</a> (uint8_t out[128])</td></tr>
<tr class="separator:a0c9a3cf6b4f6bcd72fcb25d91c2a2013"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a325a186417cb69a1c104d8887317c38a"><td class="memItemLeft" align="right" valign="top">uint64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a325a186417cb69a1c104d8887317c38a">opsick_db_get_last_db_schema_version_nr_lookup</a> ()</td></tr>
<tr class="separator:a325a186417cb69a1c104d8887317c38a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac5eb95a243883753776d550c8be05787"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#ac5eb95a243883753776d550c8be05787">opsick_db_does_user_id_exist</a> (PGconn *dbconn, uint64_t user_id)</td></tr>
<tr class="separator:ac5eb95a243883753776d550c8be05787"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6a6ff591b819d0078f3756ef15a71295"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a6a6ff591b819d0078f3756ef15a71295">opsick_db_create_user</a> (PGconn *dbconn, const char *pw, uint64_t exp_utc, const char *public_key_ed25519, const char *encrypted_private_key_ed25519, const char *public_key_curve448, const char *encrypted_private_key_curve448, uint64_t *out_user_id)</td></tr>
<tr class="separator:a6a6ff591b819d0078f3756ef15a71295"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4cc3b5fd838601aec0802103b14015e7"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a4cc3b5fd838601aec0802103b14015e7">opsick_db_delete_user</a> (PGconn *dbconn, uint64_t user_id)</td></tr>
<tr class="separator:a4cc3b5fd838601aec0802103b14015e7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab5c6c66449827a78fb3d1e5e7d4fa4a6"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#ab5c6c66449827a78fb3d1e5e7d4fa4a6">opsick_db_get_user_metadata</a> (PGconn *db, uint64_t user_id, struct <a class="el" href="structopsick__user__metadata.html">opsick_user_metadata</a> *out_user_metadata)</td></tr>
<tr class="separator:ab5c6c66449827a78fb3d1e5e7d4fa4a6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae0685b43b7aded3ea41992aed6dd1022"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#ae0685b43b7aded3ea41992aed6dd1022">opsick_db_set_user_pw</a> (PGconn *dbconn, uint64_t user_id, const char *new_pw)</td></tr>
<tr class="separator:ae0685b43b7aded3ea41992aed6dd1022"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a67677e1813d695aa4c2d82ed86d7017b"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a67677e1813d695aa4c2d82ed86d7017b">opsick_db_set_user_totps</a> (PGconn *dbconn, uint64_t user_id, const char *new_totps)</td></tr>
<tr class="separator:a67677e1813d695aa4c2d82ed86d7017b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a09b45ebffc3ae4ec662f53bebe83f3fe"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a09b45ebffc3ae4ec662f53bebe83f3fe">opsick_db_get_user_body</a> (PGconn *dbconn, uint64_t user_id, char **out_body, size_t *out_body_length)</td></tr>
<tr class="separator:a09b45ebffc3ae4ec662f53bebe83f3fe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0009e58f312a3cd57401e2ac6aad807e"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a0009e58f312a3cd57401e2ac6aad807e">opsick_db_set_user_body</a> (PGconn *dbconn, uint64_t user_id, const char *body)</td></tr>
<tr class="separator:a0009e58f312a3cd57401e2ac6aad807e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6a8ea9b2be0b7c8df97df7852b383442"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a6a8ea9b2be0b7c8df97df7852b383442">opsick_db_set_user_exp</a> (PGconn *dbconn, uint64_t user_id, uint64_t new_exp)</td></tr>
<tr class="separator:a6a8ea9b2be0b7c8df97df7852b383442"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae6e2721c534ad50e3f4eafec757c0c82"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#ae6e2721c534ad50e3f4eafec757c0c82">opsick_db_set_user_keys</a> (PGconn *dbconn, uint64_t user_id, const char *new_pubkey_ed25519, const char *new_prvkey_ed25519, const char *new_pubkey_curve448, const char *new_prvkey_curve448)</td></tr>
<tr class="separator:ae6e2721c534ad50e3f4eafec757c0c82"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a73c969a1ce317bc9e287f33b1c3974dd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8h.html#a73c969a1ce317bc9e287f33b1c3974dd">opsick_db_free</a> ()</td></tr>
<tr class="separator:a73c969a1ce317bc9e287f33b1c3974dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p >Opsick DB interaction functions. </p>
<dl class="section author"><dt>Author</dt><dd>Raphael Beck </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a85551b047f3c11fb87b8e9e7257f17bc" name="a85551b047f3c11fb87b8e9e7257f17bc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a85551b047f3c11fb87b8e9e7257f17bc">&#9670;&nbsp;</a></span>opsick_db_connect()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PGconn * opsick_db_connect </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Connects to the opsick db. </p><dl class="section return"><dt>Returns</dt><dd><code>NULL</code> if connection couldn't be established; the postgres connection reference otherwise. </dd></dl>

</div>
</div>
<a id="a6a6ff591b819d0078f3756ef15a71295" name="a6a6ff591b819d0078f3756ef15a71295"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6a6ff591b819d0078f3756ef15a71295">&#9670;&nbsp;</a></span>opsick_db_create_user()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opsick_db_create_user </td>
          <td>(</td>
          <td class="paramtype">PGconn *&#160;</td>
          <td class="paramname"><em>dbconn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>pw</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>exp_utc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>public_key_ed25519</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>encrypted_private_key_ed25519</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>public_key_curve448</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>encrypted_private_key_curve448</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t *&#160;</td>
          <td class="paramname"><em>out_user_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Adds a new user to the DB. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dbconn</td><td>Postgres db connection reference to use for the query. </td></tr>
    <tr><td class="paramname">pw</td><td>The user's password (hashed). </td></tr>
    <tr><td class="paramname">exp_utc</td><td>When the user expires (UTC). </td></tr>
    <tr><td class="paramname">public_key_ed25519</td><td>The user's public Ed25519 key. </td></tr>
    <tr><td class="paramname">encrypted_private_key_ed25519</td><td>The user's encrypted private Ed25519 key. </td></tr>
    <tr><td class="paramname">public_key_curve448</td><td>The user's public Curve448 key. </td></tr>
    <tr><td class="paramname">encrypted_private_key_curve448</td><td>The user's encrypted private Curve448 key. </td></tr>
    <tr><td class="paramname">out_user_id</td><td>Where to write the ID of the freshly created user into. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>0</code> on success; error code in case of a failure. </dd></dl>

</div>
</div>
<a id="a4cc3b5fd838601aec0802103b14015e7" name="a4cc3b5fd838601aec0802103b14015e7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4cc3b5fd838601aec0802103b14015e7">&#9670;&nbsp;</a></span>opsick_db_delete_user()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opsick_db_delete_user </td>
          <td>(</td>
          <td class="paramtype">PGconn *&#160;</td>
          <td class="paramname"><em>dbconn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>user_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Deletes a user from the DB. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dbconn</td><td>Postgres db connection reference to use for the query. </td></tr>
    <tr><td class="paramname">user_id</td><td>The user ID. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>0</code> on success; <code>1</code> if the user was not found or deletion from db failed for some other unknown reason. </dd></dl>

</div>
</div>
<a id="a36c6a53151f5713ed4a8ccf157bc09d8" name="a36c6a53151f5713ed4a8ccf157bc09d8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a36c6a53151f5713ed4a8ccf157bc09d8">&#9670;&nbsp;</a></span>opsick_db_disconnect()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void opsick_db_disconnect </td>
          <td>(</td>
          <td class="paramtype">PGconn *&#160;</td>
          <td class="paramname"><em>dbconn</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Disconnects from the opsick db. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dbconn</td><td>The postgres connection handle to disconnect. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="ac5eb95a243883753776d550c8be05787" name="ac5eb95a243883753776d550c8be05787"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac5eb95a243883753776d550c8be05787">&#9670;&nbsp;</a></span>opsick_db_does_user_id_exist()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opsick_db_does_user_id_exist </td>
          <td>(</td>
          <td class="paramtype">PGconn *&#160;</td>
          <td class="paramname"><em>dbconn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>user_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Checks whether a given user id exists or not. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dbconn</td><td>Postgres db connection reference to use for the query. </td></tr>
    <tr><td class="paramname">user_id</td><td>The user id to check. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>0</code> if the user does not exist in the db; <code>1</code> if it does exist. </dd></dl>

</div>
</div>
<a id="a73c969a1ce317bc9e287f33b1c3974dd" name="a73c969a1ce317bc9e287f33b1c3974dd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a73c969a1ce317bc9e287f33b1c3974dd">&#9670;&nbsp;</a></span>opsick_db_free()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void opsick_db_free </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >This frees all the related resources. </p>

</div>
</div>
<a id="a325a186417cb69a1c104d8887317c38a" name="a325a186417cb69a1c104d8887317c38a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a325a186417cb69a1c104d8887317c38a">&#9670;&nbsp;</a></span>opsick_db_get_last_db_schema_version_nr_lookup()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint64_t opsick_db_get_last_db_schema_version_nr_lookup </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >When was the last time somebody checked the db schema version number? </p><dl class="section return"><dt>Returns</dt><dd>UTC timestamp of the last schema version lookup. </dd></dl>

</div>
</div>
<a id="a3f5d3b4462ea61dff9dcc8b441386a54" name="a3f5d3b4462ea61dff9dcc8b441386a54"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3f5d3b4462ea61dff9dcc8b441386a54">&#9670;&nbsp;</a></span>opsick_db_get_last_used_userid()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint64_t opsick_db_get_last_used_userid </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Gets the id of the last active user. </p><dl class="section return"><dt>Returns</dt><dd>User ID of the last user who interacted with the server. </dd></dl>

</div>
</div>
<a id="a50c127ac5529eeb1c52b6e9d3d46685f" name="a50c127ac5529eeb1c52b6e9d3d46685f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a50c127ac5529eeb1c52b6e9d3d46685f">&#9670;&nbsp;</a></span>opsick_db_get_schema_version_number()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint64_t opsick_db_get_schema_version_number </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Gets the current DB schema version number (via a SELECT statement). </p>
<p >This number is increased with every DB schema migration. </p><dl class="section return"><dt>Returns</dt><dd>The current db schema version number. </dd></dl>

</div>
</div>
<a id="a09b45ebffc3ae4ec662f53bebe83f3fe" name="a09b45ebffc3ae4ec662f53bebe83f3fe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a09b45ebffc3ae4ec662f53bebe83f3fe">&#9670;&nbsp;</a></span>opsick_db_get_user_body()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opsick_db_get_user_body </td>
          <td>(</td>
          <td class="paramtype">PGconn *&#160;</td>
          <td class="paramname"><em>dbconn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>user_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>out_body</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t *&#160;</td>
          <td class="paramname"><em>out_body_length</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Retrieves a user's body from the db. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dbconn</td><td>Postgres db connection reference to use for the query. </td></tr>
    <tr><td class="paramname">user_id</td><td>User id. </td></tr>
    <tr><td class="paramname">out_body</td><td>Pointer to an output body string that will contain the retrieved user body (will be left untouched if the user couldn't be found). This will be malloc'ed on success, so don't forget to free()! </td></tr>
    <tr><td class="paramname">out_body_length</td><td>[OPTIONAL] Where to write the output body length into (can be <code>NULL</code> if you don't need it). </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>0</code> on success; <code>1</code> if the user was not found or fetch from db failed. </dd></dl>

</div>
</div>
<a id="ab5c6c66449827a78fb3d1e5e7d4fa4a6" name="ab5c6c66449827a78fb3d1e5e7d4fa4a6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab5c6c66449827a78fb3d1e5e7d4fa4a6">&#9670;&nbsp;</a></span>opsick_db_get_user_metadata()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opsick_db_get_user_metadata </td>
          <td>(</td>
          <td class="paramtype">PGconn *&#160;</td>
          <td class="paramname"><em>db</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>user_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structopsick__user__metadata.html">opsick_user_metadata</a> *&#160;</td>
          <td class="paramname"><em>out_user_metadata</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Retrieves a user's metadata from the db. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">db</td><td>Postgres db connection reference to use for the query. </td></tr>
    <tr><td class="paramname">user_id</td><td>The user ID. </td></tr>
    <tr><td class="paramname">out_user_metadata</td><td>Where to write the found metadata into (this will be left alone if the user wasn't found) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>0</code> on success; <code>1</code> if the user was not found or fetch from db failed for some other unknown reason. </dd></dl>

</div>
</div>
<a id="a277790655c65b7d13ce1197c4c1bfd94" name="a277790655c65b7d13ce1197c4c1bfd94"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a277790655c65b7d13ce1197c4c1bfd94">&#9670;&nbsp;</a></span>opsick_db_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opsick_db_init </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dbconn_filepath</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Initializes the db client, connecting to sqlite and setting up everything that's needed to query the database. </p>
<p >This terminates opsick with a status code of <code>-1</code> in case of a failure! </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dbconn_filepath</td><td>The full path to the (hopefully well-protected) text file containing the postgres connection string to use for Opsick. Ideally, you'd <code>chown</code> this to the Opsick process owner and <code>chmod</code> this to <code>400</code> (read-only, and only by the file owner and no one else). </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>1</code> if the db initialization succeeded; <code>0</code> if it failed (e.g. bad connection). </dd></dl>

</div>
</div>
<a id="a0c9a3cf6b4f6bcd72fcb25d91c2a2013" name="a0c9a3cf6b4f6bcd72fcb25d91c2a2013"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0c9a3cf6b4f6bcd72fcb25d91c2a2013">&#9670;&nbsp;</a></span>opsick_db_last_128_bytes_of_ciphertext()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void opsick_db_last_128_bytes_of_ciphertext </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>out</em>[128]</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Gets the last 128B of trafficked ciphertext. </p><dl class="section return"><dt>Returns</dt><dd></dd></dl>

</div>
</div>
<a id="a0009e58f312a3cd57401e2ac6aad807e" name="a0009e58f312a3cd57401e2ac6aad807e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0009e58f312a3cd57401e2ac6aad807e">&#9670;&nbsp;</a></span>opsick_db_set_user_body()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opsick_db_set_user_body </td>
          <td>(</td>
          <td class="paramtype">PGconn *&#160;</td>
          <td class="paramname"><em>dbconn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>user_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>body</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Updates a user's body in the db. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dbconn</td><td>Postgres db connection reference to use for the query. </td></tr>
    <tr><td class="paramname">user_id</td><td>User id. </td></tr>
    <tr><td class="paramname">body</td><td>The new body to write into the db. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>0</code> on success; non-zero on failure. </dd></dl>

</div>
</div>
<a id="a6a8ea9b2be0b7c8df97df7852b383442" name="a6a8ea9b2be0b7c8df97df7852b383442"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6a8ea9b2be0b7c8df97df7852b383442">&#9670;&nbsp;</a></span>opsick_db_set_user_exp()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opsick_db_set_user_exp </td>
          <td>(</td>
          <td class="paramtype">PGconn *&#160;</td>
          <td class="paramname"><em>dbconn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>user_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>new_exp</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Sets a new expiration datetime (UTC) to a user in the db. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dbconn</td><td>Postgres db connection reference to use for the query. </td></tr>
    <tr><td class="paramname">user_id</td><td>ID of the user whose expiration date needs to be changed. </td></tr>
    <tr><td class="paramname">new_exp</td><td>The new UTC timestamp of when the user account will become read-only. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>0</code> on success; non-zero on failure. </dd></dl>

</div>
</div>
<a id="ae6e2721c534ad50e3f4eafec757c0c82" name="ae6e2721c534ad50e3f4eafec757c0c82"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae6e2721c534ad50e3f4eafec757c0c82">&#9670;&nbsp;</a></span>opsick_db_set_user_keys()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opsick_db_set_user_keys </td>
          <td>(</td>
          <td class="paramtype">PGconn *&#160;</td>
          <td class="paramname"><em>dbconn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>user_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_pubkey_ed25519</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_prvkey_ed25519</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_pubkey_curve448</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_prvkey_curve448</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Updates a user's key pairs in the db. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dbconn</td><td>Postgres db connection reference to use for the query. </td></tr>
    <tr><td class="paramname">user_id</td><td>User id. </td></tr>
    <tr><td class="paramname">new_pubkey_ed25519</td><td>The new ed25519 public key (NUL-terminated C-string). </td></tr>
    <tr><td class="paramname">new_prvkey_ed25519</td><td>The new ed25519 encrypted private key (NUL-terminated C-string). </td></tr>
    <tr><td class="paramname">new_pubkey_curve448</td><td>The new curve448 public key (NUL-terminated C-string). </td></tr>
    <tr><td class="paramname">new_prvkey_curve448</td><td>The new curve448 encrypted private key (NUL-terminated C-string). </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>0</code> on success; non-zero on failure. </dd></dl>

</div>
</div>
<a id="ae0685b43b7aded3ea41992aed6dd1022" name="ae0685b43b7aded3ea41992aed6dd1022"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae0685b43b7aded3ea41992aed6dd1022">&#9670;&nbsp;</a></span>opsick_db_set_user_pw()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opsick_db_set_user_pw </td>
          <td>(</td>
          <td class="paramtype">PGconn *&#160;</td>
          <td class="paramname"><em>dbconn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>user_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_pw</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Changes a user's password in the db. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dbconn</td><td>Postgres db connection reference to use for the query. </td></tr>
    <tr><td class="paramname">user_id</td><td>User ID whose password you want to change. </td></tr>
    <tr><td class="paramname">new_pw</td><td>The new pw hash. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>0</code> on success; <code>1</code> on failure. </dd></dl>

</div>
</div>
<a id="a67677e1813d695aa4c2d82ed86d7017b" name="a67677e1813d695aa4c2d82ed86d7017b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a67677e1813d695aa4c2d82ed86d7017b">&#9670;&nbsp;</a></span>opsick_db_set_user_totps()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int opsick_db_set_user_totps </td>
          <td>(</td>
          <td class="paramtype">PGconn *&#160;</td>
          <td class="paramname"><em>dbconn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>user_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_totps</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Changes a user's TOTPS (TOTP secret for 2FA) in the db. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dbconn</td><td>Postgres db connection reference to use for the query. </td></tr>
    <tr><td class="paramname">user_id</td><td>User ID whose TOTPS you want to change. </td></tr>
    <tr><td class="paramname">new_pw</td><td>The new TOTPS (base32 encoded). </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>0</code> on success; <code>1</code> on failure. </dd></dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
